<!DOCTYPE html>
 
<html lang="en">
 
<head>
	<link rel="apple-touch-icon" sizes="57x57" href="/theme/default/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="/theme/default/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/theme/default/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/theme/default/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/theme/default/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/theme/default/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="/theme/default/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/theme/default/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/theme/default/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="/theme/default/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/theme/default/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="/theme/default/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/theme/default/favicon/favicon-16x16.png">
	<link rel="manifest" href="/theme/default/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/theme/default/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">
	<meta charset="utf-8">
	<title>OOBD Fehlerspeicher auslesen</title>
	<!--meta name="viewport" content="width=device-width, initial-scale=1"-->
	<!--
	<link rel="stylesheet" href="themes/warnings.min.css" />
	<link rel="stylesheet" href="themes/jquery.mobile.icons.min.css" />
	-->
	<link rel="stylesheet" type="text/css" href="/libs/gridster/0.5.6/jquery.gridster.css">
	<link rel="stylesheet" href="/libs/jquery-ui/1.11.4/jquery-ui.css">
 

	<!--
	<link rel="stylesheet" href="libs/jquery.mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css" />
	<link rel="stylesheet" href="/libs/jquery.mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	-->
	<script src="/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src="/libs/jquery-ui/1.11.4/jquery-ui.js"></script>
	<!--
	<script src="/libs/jquery.mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	-->
	<script src="/libs/gridster/0.5.6/jquery.gridster.js" type="text/javascript" charset="utf-8"></script>


	<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
	<meta name="msapplication-tap-highlight" content="no" />
	<link rel="stylesheet" href="/libs/jqwidgets/3.8.2/styles/jqx.base.css" type="text/css" />
	<link rel="stylesheet" href="/libs/jqwidgets/3.8.2/styles/jqx.windowsphone.css" type="text/css" />
	<link rel="stylesheet" href="/libs/jqwidgets/3.8.2/styles/jqx.blackberry.css" type="text/css" />
	<link rel="stylesheet" href="/libs/jqwidgets/3.8.2/styles/jqx.android.css" type="text/css" />
	<link rel="stylesheet" href="/libs/jqwidgets/3.8.2/styles/jqx.mobile.css" type="text/css" />
	<link rel="stylesheet" type="text/css" href="/theme/default/css/style.css" />
	<script type="text/javascript" src="/libs/jqwidgets/3.8.2/jqxcore.js"></script>
	<script type="text/javascript" src="/libs/jqwidgets/3.8.2/jqxdata.js"></script>
	<!--script type="text/javascript" src="../simulator.js"></script-->
	<script type="text/javascript" src="/libs/jqwidgets/3.8.2/jqxchart.js"></script>
	<script type="text/javascript" src="/libs/jqwidgets/3.8.2/jqxgauge.js"></script>
	<script type="text/javascript" src="/libs/jqwidgets/3.8.2/jqxbuttons.js"></script>



	<meta charset="utf-8">
	<script type="text/javascript" src="/libs/oobd/1/oobd.js"></script>
	<style>
		:invalid {
		border: 2px solid #ff0000;
		}
	</style>
	<script>
		$(function() {
			$( "#tabs" ).tabs();
		});
	</script>
</head>
 
<body>

<img src="/libs/images/oobd_logo_tron.png" width="100">

<button onclick="Oobd.update()">Update</button><label><input type='checkbox' onclick='Oobd.timer(this.checked);'>Timer</label>

<div id="tabs">
	<ul>
	<li><a href="#datatab">Data</a></li>
	<li><a href="#outputtab">Output and Buffer</a></li>
	<li><a href="#dashtab">Dashboard</a></li>
	</ul>
	<div id="datatab">
		<div id="values" class="gridster">
			<ul>
			</ul>
		</div>
		<div id="dropzone" class="dropzone" ondragenter="return handleDragEnter(event)" ondrop="return handledragDropAdd(event)"   ondragover="return handleDragOver(event)">Dashboard<br/>(drop items here for quick access,<br/>
		your selection will be saved in the browser)
		</div>
	</div>
	<div id="dashtab">
		<div id="dashboard" class="gridster">
			<ul>
			</ul>
		</div>
		<div id="trashbin" class="dropzone" ondragenter="return handleDragEnter(event)" ondrop="return handledragDropDelete(event)"   ondragover="return handleDragOver(event)">Trashbin<br/>(drop your dashboard items here to remove them)
		</div>
	</div>
	<div id="outputtab">
		<textarea id="textoutput"></textarea>
		<p />
		<a href="#" onclick="return saveOutput('output.txt');">Save Output</a>
		<table id="files">
		</table>
	</div>
 
	<script>
		var gridster=[];
		$(function(){ //DOM Ready
			// your page initialization code here
			// the DOM will be available here

			//define here what to do if a text comes in to be shown
			Oobd.writeString = function addText(text,cmd) {
				switch (cmd){
					case "clear":
						document.getElementById("textoutput").value="";
						break;
					case "save":
						saveOutput(text);
						break;
					default:
						document.getElementById("textoutput").value += text;
						break;
				}
			}

			gridster[0]=$("#values ul").gridster({
				namespace: '#values',
				widget_margins: [5, 5],
				widget_base_dimensions: [140, 140],
				max_cols: 6,
				helper: 'clone',
				resize: {
					enabled: true
				}
			}).data('gridster');
			gridster[1]=$("#dashboard ul").gridster({
				namespace: '#dashboard',
				widget_margins: [5, 5],
				//widget_base_dimensions: [300, 300],
				helper: 'clone',
				resize: {
					enabled: true
				}
			}).data('gridster');
			// initialize a new OOBD page to be shown
			Oobd.openPage = function openPage(text) {
				window.document.title=text;
				gridster[0].remove_all_widgets();
				Oobd.clearVisualiers();
			}

			// add a new visual element to the page
			Oobd.visualize = function visualize(obj) {
				gridster[0].add_widget(constructVisualizer(obj),2,1);
				}
			Oobd.fillDashboard = function fillDash() {
				var res=Oobd.getDashContructors();
				for (var i = 0; i < res.length; i++) {
					gridster[1].add_widget(constructVisualizer(JSON.parse(res[i])),2,1);
				}
			}
			Oobd.start();
		});
		function constructVisualizer(obj){
				var tbl = document.createElement('li');
				//tbl.style.width = '100%';
				// to not do this all with DOM commands, we do it at once as innerHTML
				tbl.innerHTML='<div class="oobd-name" display="block">blu</div>\
				<div class="oobd-value" display="block">bla</div>\
				<div class="oobd-unit" display="block">Volt</div>\
				<div class="oobd-update-icon_0"></div>\
				</tr>';
				//var tbdy = document.createElement('tbody');
				//var row = document.createElement('tr');
				tbl.classList.add("OOBD");
				tbl.setAttribute("oobd:fc",obj.name);
				tbl.setAttribute("oobd:value",decodeURIComponent(escape(atob(obj.value))));
				tbl.setAttribute("draggable","true");
				tbl.setAttribute("oobd:constructor",JSON.stringify(obj));
				tbl.addEventListener('dragstart', handleDragStart, false);
				//row.addEventListener('dragenter', handleDragEnter, false);
				//row.addEventListener('dragover', handleDragOver, false);
				//row.addEventListener('dragleave', handleDragLeave, false);

				if (typeof obj.updevents != "undefined" ) {
					tbl.setAttribute("oobd:updevents",obj.updevents);
				}else{
					tbl.setAttribute("oobd:updevents",0);
				}

				// Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
				// var cell1 = row.insertCell(0);
				var cell1 = tbl.getElementsByClassName("oobd-name")[0];
				var cell2 = tbl.getElementsByClassName("oobd-value")[0];
				//tbdy.appendChild(row);
				//row = document.createElement('tr');
				//var cell2 = row.insertCell(0);
				//cell1.classList.add("name");
				//cell2.classList.add("value");
				// Add some text to the new cells:
				cell1.innerHTML = decodeURIComponent(escape(atob(obj.tooltip)));
				//let see, if the visualizer is a graphic element
				if(typeof obj.opts == 'undefined'){
					//the simple way
					tbl.setAttribute("oobd:click","yes");
					cell2.innerHTML = decodeURIComponent(escape(atob(obj.value)));
					tbl.oodbupdate = function(input) {
						//this.getElementsByClassName("value")[0].innerHTML = input.value;
						cell2.innerHTML=input.value;
					};
				}else{
					switch (obj.opts.type){
					case "TextEdit":
					case "Password":
						 var feld = document.createElement("input");
						if ( obj.opts.type == "Password" ){
							feld.setAttribute("type","text"); 
						}else{
							feld.setAttribute("type","text"); 
						}
						feld.setAttribute("size","30"); 
						feld.value=decodeURIComponent(escape(atob(obj.value)));
						if(typeof obj.opts.regex != 'undefined'){
							feld.setAttribute("pattern",obj.opts.regex); 
						}
						tbl.oodbupdate = function(input) {
							feld.value = input.value;
						};
						feld.onchange=function(){
							if (feld.checkValidity()){
								console.log("update text input");
								Oobd.sendUpdateReq(tbl.oobd.command, tbl.oobd.optid, feld.value, 0);
							}
						};
						cell2.appendChild(feld); 
						break;
					case "CheckBox":
						 var feld = document.createElement("input");
						feld.setAttribute("type","checkbox"); 
						feld.checked = "true" == decodeURIComponent(escape(atob(obj.value))).toLowerCase();
						tbl.oodbupdate = function(input) {
							feld.checked = "true" == input.value.toLowerCase();
						};
						feld.onchange=function(){
							console.log("update checkbox");
							var flag= feld.checked ? "True" : "False";
							Oobd.sendUpdateReq(tbl.oobd.command, tbl.oobd.optid, flag, 0);
						};
						cell2.appendChild(feld); 
						break;
					case "Slider":
						var feld = document.createElement("input");
						feld.setAttribute("type","range");
						feld.setAttribute("min",obj.opts.min); 
						feld.setAttribute("max",obj.opts.max); 
						feld.setAttribute("step",obj.opts.step); 
						feld.value = parseFloat(decodeURIComponent(escape(atob(obj.value))));
						tbl.oodbupdate = function(input) {
							feld.value = parseFloat(input.value);
						};
						feld.onchange=function(){
							console.log("update range");
							var flag= feld.value.toString();
							Oobd.sendUpdateReq(tbl.oobd.command, tbl.oobd.optid, flag, 0);
						};
						cell2.appendChild(feld); 
						break;					case "Combo":
						 var feld = document.createElement("select");
						var opt = null;
						var unsortedList = obj.opts.content;
						var deptList= new Array(unsortedList.length);
						for (var prop in unsortedList) {
							if (unsortedList.hasOwnProperty(prop)) { 
								// or if (Object.prototype.hasOwnProperty.call(obj,prop)) for safety...
								deptList[parseInt(prop)-1]=unsortedList[prop];
							}
						}
						for(i = 0; i< deptList.length; i++) { 

							opt = document.createElement('option');
							opt.value = i+1;
							opt.innerHTML = deptList[i];
							feld.appendChild(opt);
						}
						feld.selectedIndex =parseInt(decodeURIComponent(escape(atob(obj.value))))-1;
						tbl.oodbupdate = function(input) {
							feld.selectedIndex =  parseInt(input.value)-1;
						};
						feld.onchange=function(){
							console.log("update combobox");
							var flag= (feld.selectedIndex+1).toString();
							Oobd.sendUpdateReq(tbl.oobd.command, tbl.oobd.optid, flag, 0);
						};
						cell2.appendChild(feld); 
						break;
					case "Gauge":
						 var feld = document.createElement("meter");
						feld.setAttribute("min",obj.opts.min); 
						feld.setAttribute("max",obj.opts.max); 
						feld.setAttribute("high",obj.opts.high); 
						feld.setAttribute("low",obj.opts.low); 
						feld.setAttribute("optimum",obj.opts.optimum); 
						feld.value = parseFloat(decodeURIComponent(escape(atob(obj.value))));
						tbl.oodbupdate = function(input) {
							feld.value = parseFloat(input.value);
						};
						/* A meter is readonly, so no onchange 
						feld.onchange=function(){
							console.log("update checkbox");
							var flag= feld.checked ? "True" : "False";
							Oobd.sendUpdateReq(tbl.oobd.command, tbl.oobd.optid, flag, 0);
						};
						*/
						cell2.appendChild(feld); 
						break;
					}
				}
				//tbdy.appendChild(row);
				//tbl.appendChild(tbdy);		
				Oobd.addObject(tbl, decodeURIComponent(escape(atob(obj.value))));
				return tbl
			}

			// add file buffer changes to the page
			Oobd.fileChange = function fileChange(id,url,change) {
				console.log("callback on File change: " + change + " for id " + id + " with URL "+ url );
				var table = document.getElementById("files");
				// Create an empty <tr> element and add it to the last position of the table:
				var row = table.insertRow(-1);

				row.setAttribute("id","oobd-file-"+id);


				// Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
				var cell1 = row.insertCell(0);
				var cell2 = row.insertCell(1);
				if (url!=""){
				var a = document.createElement('a');
					a.download = id;
					a.href = url;
					a.textContent = id;
					cell1.appendChild(a);
				}else{
					cell1.innerHTML = decodeURIComponent(escape(id));
				}
				// Add some text to the new cells:
				cell2.innerHTML = decodeURIComponent(escape(change));
			};		
		function saveOutput(fileName){
			var blob = new Blob([document.getElementById("textoutput").value], {
			type: "text/plain;charset=utf-8"
			});
			var url = URL.createObjectURL(blob);

			var a = document.createElement('a');
			a.download = fileName;
			a.href = url;
			a.textContent = "Save Output";
			a.click();
			//if the click() function dosen't work you can try using onclick() fucntion like this
			//a.onclick();
			return false;
		};
		function handleDragStart(ev) {
			ev.dataTransfer.effectAllowed='move';
			ev.dataTransfer.setData("Text", ev.target.getAttribute('oobd:constructor'));
			ev.dataTransfer.setDragImage(ev.target,0,0);
			return true;
  		}
		function handleDragOver(e) {
			return false;
		}
		function handleDragEnter(e) {
			event.preventDefault();
			return true;
		}

		function handleDragLeave(e) {
			this.classList.remove('over');  // this / e.target is previous target element.
		}
		function handledragDropAdd(ev) {
			var src = ev.dataTransfer.getData("Text");
			var res=Oobd.addToDash(src);
			for (var i = 0; i < res.length; i++) {
				gridster[1].add_widget(constructVisualizer(JSON.parse(res[i])),2,1);
			}
			ev.stopPropagation();
			return false;
		}
		function handledragDropDelete(ev) {
			var src = ev.dataTransfer.getData("Text");
			var table = document.getElementById("dashboard");
			while(table.hasChildNodes())
			{
				table.removeChild(table.firstChild);
			}

			var res=Oobd.removeFromDash(src);
			for (var i = 0; i < res.length; i++) {
				// Create an empty <tr> element and add it to the last position of the table:
				var row = table.insertRow(-1);
				gridster[1].add_widget(constructVisualizer(JSON.parse(res[i])),2,1);
			}
			ev.stopPropagation();
			return false;
		}

	</script>
</body>
 
</html>